<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Granduer Test Client (Flask)</title>
  <style>
    body{font-family:system-ui,Segoe UI,Arial;margin:20px}
    input,select,button{padding:8px;margin:4px}
    .row{margin:8px 0}
    .msg{border:1px solid #ddd;margin:4px 0;padding:6px;border-radius:8px}
  </style>
</head>
<body>
  <h1>Granduer Test Client (Flask)</h1>
  <div class="row"><strong>Server:</strong> <input id="base" value="http://127.0.0.1:5000" size="32" /></div>

  <h3>Auth</h3>
  <div class="row">
    <input id="email" placeholder="email" />
    <input id="name" placeholder="name" />
    <input id="password" type="password" placeholder="password" />
    <button onclick="signup()">Sign up</button>
    <button onclick="login()">Login</button>
  </div>
  <div class="row">Token: <code id="token"></code></div>

  <h3>Rooms</h3>
  <div class="row">
    <select id="clientType">
      <option value="student">student</option>
      <option value="visitor">visitor</option>
      <option value="worker">worker</option>
    </select>
    <input id="roomName" placeholder="Room name" />
    <button onclick="createRoom()">Create Room</button>
    <button onclick="listRooms()">List My Rooms</button>
  </div>
  <div class="row">
    Active Room ID: <input id="roomId" size="6" />
    <button onclick="loadMessages()">Load Messages</button>
  </div>

  <h3>Chat</h3>
  <div class="row">
    <input id="text" placeholder="Type message" size="40" />
    <button onclick="sendMessage()">Send</button>
  </div>
  <div class="row">
    <input id="file" type="file" />
    <button onclick="uploadFile()">Upload</button>
  </div>

  <div id="log"></div>

  <script>
    let jwtToken = '';
    const $ = id => document.getElementById(id);
    const log = (x) => { const div = document.createElement('div'); div.className='msg'; div.textContent = typeof x==='string'?x:JSON.stringify(x,null,2); $('log').prepend(div); };

    async function post(url, body) {
      const r = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type':'application/json', ...(jwtToken?{Authorization:`Bearer ${jwtToken}`}:{}) },
        body: JSON.stringify(body||{})
      });
      return r.json();
    }
    async function get(url) {
      const r = await fetch(url, { headers: { ...(jwtToken?{Authorization:`Bearer ${jwtToken}`}:{}) } });
      return r.json();
    }

    async function signup(){
      const res = await post(`${$('base').value}/auth/signup`, { email:$('email').value, password:$('password').value, name:$('name').value });
      if(res.token){ jwtToken=res.token; $('token').textContent=jwtToken; log('Signup OK'); } else log(res);
    }
    async function login(){
      const res = await post(`${$('base').value}/auth/login`, { email:$('email').value, password:$('password').value });
      if(res.token){ jwtToken=res.token; $('token').textContent=jwtToken; log('Login OK'); } else log(res);
    }
    async function createRoom(){
      const res = await post(`${$('base').value}/rooms`, { name:$('roomName').value, clientType:$('clientType').value });
      if(res.id){ $('roomId').value = res.id; log(res); } else log(res);
    }
    async function listRooms(){
      const res = await get(`${$('base').value}/rooms`);
      log(res);
      if(res[0]) $('roomId').value = res[0].id;
    }
    async function loadMessages(){
      const id = $('roomId').value;
      const res = await get(`${$('base').value}/rooms/${id}/messages`);
      log(res);
    }
    async function sendMessage(){
      const id = $('roomId').value;
      const res = await post(`${$('base').value}/rooms/${id}/messages`, { text:$('text').value });
      log(res);
    }
    async function uploadFile(){
      const id = $('roomId').value;
      const f = $('file').files[0]; if(!f){ return log('Choose a file'); }
      const fd = new FormData(); fd.append('file', f);
      const r = await fetch(`${$('base').value}/rooms/${id}/upload`, {
        method:'POST', headers: { ...(jwtToken?{Authorization:`Bearer ${jwtToken}`}:{}) }, body: fd
      });
      log(await r.json());
    }
  </script>
</body>
</html>
